<!-- /admin/index.html -->
<!doctype html>
<html lang="es-AR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin | Di Pietro</title>
  <meta name="description" content="Panel admin: productos + imagenes." />
  <meta name="theme-color" content="#0b1220" />

  <!-- PWA (manifest via data URL) -->
  <link rel="manifest" id="manifestLink" href="" />
  <link rel="apple-touch-icon" href="https://iili.io/qFHQVmN.png" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg: #fbf7f0;
  --panel: rgba(255,255,255,.78);
  --panel2: rgba(255,255,255,.70);
  --text: #1f2937;
  --muted: #6b7280;
  --line: rgba(31,41,55,.10);
  --shadow: 0 18px 60px rgba(31,41,55,.12);

  --accent: #f97316;
  --accent2: #8b5cf6;

  --danger: rgba(239,68,68,.14);
  --dangerLine: rgba(239,68,68,.18);
  --dangerText: #7f1d1d;

  --topbarBg: rgba(251,247,240,.75);
  --inputBg: rgba(255,255,255,.84);

  --cian: #22d3ee;
}

html[data-theme="dark"]{
  --bg: #0b1220;
  --panel: rgba(17,24,39,.72);
  --panel2: rgba(17,24,39,.62);
  --text: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.68);
  --line: rgba(255,255,255,.12);
  --shadow: 0 18px 70px rgba(0,0,0,.45);

  --topbarBg: rgba(10,15,28,.72);
  --inputBg: rgba(17,24,39,.78);

  --dangerText: #fecaca;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color: var(--text);
  background:
    radial-gradient(900px 600px at 15% -10%, rgba(255, 225, 207, .45), transparent 55%),
    radial-gradient(900px 600px at 90% 0%, rgba(223, 247, 238, .40), transparent 55%),
    radial-gradient(900px 600px at 70% 95%, rgba(236, 233, 255, .45), transparent 55%),
    var(--bg);
}
.wrap{width:min(1120px, 92vw); margin:0 auto}

.topbar{
  position:sticky; top:0; z-index:50;
  backdrop-filter: blur(10px);
  background: var(--topbarBg);
  border-bottom: 1px solid var(--line);
}
.topbar__inner{display:flex; align-items:center; justify-content:space-between; padding:14px 0; gap:12px}
.topbar__right{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
.brand__title{font-weight:1100}
.brand__subtitle{color:var(--muted); font-size:13px; margin-top:2px}
.muted{color:var(--muted); font-size:13px}

.panel{
  margin: 18px 0;
  border: 1px solid var(--line);
  border-radius: 22px;
  background: var(--panel);
  box-shadow: var(--shadow);
  padding: 14px;
}
.panel h1{margin:0 0 6px}
.panel h2{margin:0}
.admin{padding-bottom: 30px}

.grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin:10px 0}
.field label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
.field input, .field select, .field textarea{
  width:100%;
  padding:11px 12px;
  border-radius: 14px;
  border:1px solid var(--line);
  background: var(--inputBg);
  color: var(--text);
  outline:none;
  box-shadow: 0 10px 30px rgba(31,41,55,.06);
}
.field textarea{resize:vertical}

.btn{
  border:1px solid var(--line);
  background: rgba(255,255,255,.16);
  color: var(--text);
  padding: 10px 12px;
  border-radius: 14px;
  cursor:pointer;
  font-weight:1100;
  box-shadow: 0 10px 30px rgba(31,41,55,.10);
  backdrop-filter: blur(10px);
}
html[data-theme="light"] .btn{background: rgba(255,255,255,.84)}
.btn--primary{
  background: linear-gradient(135deg, rgba(249,115,22,.95), rgba(139,92,246,.55));
  border-color: rgba(249,115,22,.22);
  color: #1b1208;
}
.btn--ghost{background: rgba(255,255,255,.18)}
html[data-theme="light"] .btn--ghost{background: rgba(255,255,255,.72)}
.btn--danger{background: var(--danger); border-color: var(--dangerLine); color: var(--dangerText)}
.btn--mini{padding:8px 10px; border-radius: 12px; font-size:12px}
.btnIcon{display:flex; align-items:center; gap:10px}
.dot{
  width:10px; height:10px; border-radius:999px;
  background: linear-gradient(135deg, rgba(249,115,22,.95), rgba(139,92,246,.55));
  box-shadow: 0 10px 30px rgba(0,0,0,.18);
}

.msg{margin-top:10px; color: var(--muted); font-size:13px; line-height:1.35; min-height:18px}

.preview{
  width:100%;
  aspect-ratio: 4 / 3;
  border-radius: 18px;
  border:1px solid var(--line);
  background: var(--panel2);
  overflow:hidden;
}
.preview img{width:100%; height:100%; object-fit:cover; display:block}

.row{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
.rowLeft{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
.rowRight{display:flex; align-items:center; gap:10px; flex-wrap:wrap}

.list{margin-top:12px; display:flex; flex-direction:column; gap:10px}
.item{
  border:1px solid rgba(31,41,55,.10);
  border-radius: 18px;
  background: var(--panel2);
  padding: 12px;
  display:grid;
  grid-template-columns: 1fr auto;
  gap:10px;
}
.item__title{font-weight:1200}
.item__meta{color:var(--muted); font-size:12px; margin-top:4px}
.item__actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}

.thumb{
  width:56px; height:42px;
  border-radius: 12px;
  border:1px solid var(--line);
  overflow:hidden;
  background: rgba(255,255,255,.10);
  cursor:pointer;
}
.thumb img{width:100%; height:100%; object-fit:cover; display:block}

.pill{
  display:inline-flex; align-items:center; justify-content:center;
  padding:6px 10px;
  border-radius: 999px;
  border:1px solid rgba(31,41,55,.10);
  background: rgba(31,41,55,.04);
  font-size:12px;
  font-weight:1100;
  color: var(--text);
}
html[data-theme="dark"] .pill{background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10)}
.pill--promo{
  border-color: rgba(249,115,22,.22);
  background: rgba(249,115,22,.12);
  color: #ffedd5;
}
html[data-theme="light"] .pill--promo{color:#7c2d12}

.chk{
  display:flex; align-items:center; gap:8px;
  padding:8px 10px;
  border-radius: 14px;
  border:1px solid rgba(31,41,55,.10);
  background: rgba(255,255,255,.12);
  font-weight:1100;
  font-size:12px;
}
html[data-theme="light"] .chk{background: rgba(255,255,255,.70)}
.chk input{margin:0}

.footer{border-top:1px solid var(--line); background: rgba(255,255,255,.08)}
html[data-theme="light"] .footer{background: rgba(255,255,255,.45)}
.footer__inner{padding: 18px 0; color: var(--muted); display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between}
.footerLinks{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.linkBtn{text-decoration:none; display:inline-flex; align-items:center; gap:8px}

.brandCredit{
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-weight:1000;
  color: var(--muted);
  text-decoration:none;
}
.brandCredit:hover{opacity:.95; text-decoration:underline}
.brandCredit .cian{color: var(--cian); text-decoration: underline}
.brandCredit .miniLogo{
  width:18px; height:18px; border-radius:6px; display:block; object-fit:contain;
  border:1px solid var(--line); background: rgba(255,255,255,.10);
}

.helpBox{
  margin-top:12px;
  border:1px solid var(--line);
  border-radius: 18px;
  background: var(--panel2);
  padding: 12px;
}
.helpBox h3{margin:0 0 8px; font-size:14px}
.helpSteps{
  margin:0;
  padding-left: 18px;
  color: var(--muted);
  font-size:13px;
  line-height:1.45;
}
.helpSteps li{margin:6px 0}

/* Modal promo + modal imagen */
.modal{position:fixed; inset:0; display:none; z-index:90}
.modal.isOpen{display:block}
.modal__backdrop{position:absolute; inset:0; border:0; background: rgba(17,24,39,.55); cursor:pointer}
.modal__panel{
  position:relative;
  width: min(820px, 92vw);
  margin: 8vh auto;
  border-radius: 22px;
  border:1px solid rgba(255,255,255,.25);
  background: rgba(255,255,255,.92);
  backdrop-filter: blur(12px);
  box-shadow: 0 18px 60px rgba(31,41,55,.30);
  overflow:hidden;
}
html[data-theme="dark"] .modal__panel{background: rgba(17,24,39,.86)}
.modal__header{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid rgba(31,41,55,.12)}
html[data-theme="dark"] .modal__header{border-bottom-color: rgba(255,255,255,.10)}
.modal__title{font-weight:1100}
.modal__body{padding:14px}
.modal__actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}

.bigImg{
  width:100%;
  border-radius: 18px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.10);
  overflow:hidden;
}
.bigImg img{width:100%; height:auto; display:block}
.codeLine{
  margin-top:10px;
  padding:10px 12px;
  border-radius: 14px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.12);
  color: var(--muted);
  font-size:12px;
  word-break: break-all;
}
html[data-theme="light"] .codeLine{background: rgba(255,255,255,.70)}

@media (max-width: 900px){
  .grid2{grid-template-columns: 1fr}
  .item{grid-template-columns: 1fr}
  .item__actions{justify-content:flex-start}
}

/* Splash / loader */
.splash{
  position:fixed;
  inset:0;
  z-index:200;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(10,15,28,.86);
  backdrop-filter: blur(10px);
}
.splashCard{
  width: min(520px, 92vw);
  border-radius: 24px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(17,24,39,.70);
  box-shadow: 0 26px 90px rgba(0,0,0,.55);
  overflow:hidden;
}
.splashBody{
  padding: 18px;
  display:flex;
  align-items:center;
  gap:14px;
}
.splashImg{
  width:58px; height:58px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  overflow:hidden;
}
.splashImg img{width:100%; height:100%; object-fit:cover; display:block}
.splashText{flex:1}
.splashTitle{
  margin:0;
  font-weight:1100;
  color: rgba(255,255,255,.92);
  font-size:14px;
}
.splashTitle .cian{color: var(--cian); text-decoration: underline}
.splashSub{
  margin:6px 0 0;
  color: rgba(255,255,255,.70);
  font-size:12px;
  line-height:1.4;
}
.splashBar{
  height:3px;
  background: rgba(255,255,255,.10);
}
.splashBar > span{
  display:block;
  height:100%;
  width:46%;
  background: linear-gradient(90deg, rgba(34,211,238,.95), rgba(139,92,246,.70), rgba(249,115,22,.70));
  animation: loadPulse 1.1s ease-in-out infinite alternate;
}
@keyframes loadPulse{
  from{transform: translateX(-20%)}
  to{transform: translateX(120%)}
}
</style>
</head>

<body>

  <!-- Splash (antes de ver el sistema) -->
  <div class="splash" id="splash" aria-hidden="false">
    <div class="splashCard">
      <div class="splashBody">
        <div class="splashImg">
          <img src="https://iili.io/qFHQVmN.png" alt="App" />
        </div>
        <div class="splashText">
          <p class="splashTitle">Creado y dise単ado por <span class="cian">Ciborg</span> 347</p>
          <p class="splashSub">Iniciando panel admin...</p>
        </div>
      </div>
      <div class="splashBar"><span></span></div>
    </div>
  </div>

  <header class="topbar">
    <div class="wrap topbar__inner">
      <div class="brand">
        <div class="brand__title">Admin</div>
        <div class="brand__subtitle">Di Pietro | Productos</div>
      </div>
      <div class="topbar__right">
        <button id="themeBtn" class="btn btn--ghost btnIcon" type="button" title="Tema claro/oscuro">
          <span class="dot" aria-hidden="true"></span>
          <span id="themeTxt">Tema</span>
        </button>
        <span id="userEmail" class="muted"></span>
        <button id="logoutBtn" class="btn btn--ghost" type="button">Salir</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="authBox" class="panel">
      <h1>Ingresar</h1>
      <p class="muted">Solo usuarios autorizados (tabla admin_users).</p>

      <div class="grid2">
        <div class="field">
          <label>Email</label>
          <input id="emailInput" type="email" autocomplete="email" placeholder="ciborg347@gmail.com" />
        </div>
        <div class="field">
          <label>Password</label>
          <input id="passInput" type="password" autocomplete="current-password" />
        </div>
      </div>

      <button id="loginBtn" class="btn btn--primary" type="button">Ingresar</button>
      <div id="authMsg" class="msg"></div>

      <div class="helpBox">
        <h3>Como usar este panel</h3>
        <ol class="helpSteps">
          <li>Inicia sesion con tu email y password.</li>
          <li>Para cargar un producto: selecciona una imagen, completa nombre, precio, categoria y descripcion, y toca Publicar.</li>
          <li>Para activar/desactivar: usa el boton Activar/Desactivar en la lista.</li>
          <li>Para promocion: toca Promocion en el producto y completa etiqueta y precio.</li>
          <li>Para ver una imagen grande: toca la miniatura del producto.</li>
        </ol>
      </div>

      <div style="margin-top:12px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center">
        <a class="brandCredit" href="https://ciborg347.onrender.com" target="_blank" rel="noopener">
          <img class="miniLogo" src="https://iili.io/qFHQVmN.png" alt="" />
          <span>Creado y dise単ado por <span class="cian">Ciborg</span> 347</span>
        </a>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <a class="btn btn--ghost btn--mini linkBtn" href="mailto:ciborg347@gmail.com?subject=Sugerencias%20Admin%20Di%20Pietro&body=Hola%20Mart%C3%ADn%2C%20te%20dejo%20una%20sugerencia%20sobre%20el%20panel%20admin%3A%0A%0A" target="_blank" rel="noopener">
            Sugerencias sobre el sitio
          </a>
          <a class="btn btn--ghost btn--mini linkBtn" href="mailto:ciborg347@gmail.com?subject=Reporte%20de%20inconveniente%20Admin%20Di%20Pietro&body=Hola%20Mart%C3%ADn%2C%20quiero%20reportar%20un%20inconveniente%3A%0A%0APasos%20para%20reproducir%3A%0A1)%0A2)%0A%0AResultado%20esperado%3A%0A%0AResultado%20actual%3A%0A%0A" target="_blank" rel="noopener">
            Reportar inconvenientes
          </a>
        </div>
      </div>
    </section>

    <section id="adminBox" class="admin" style="display:none">
      <section class="panel">
        <h2>Nuevo producto</h2>
        <p class="muted">1) Subis la foto 2) completas los datos 3) publicas.</p>

        <div class="grid2">
          <div class="field">
            <label>Imagen</label>
            <input id="imageInput" type="file" accept="image/*" />
            <small class="muted">Se sube automaticamente al seleccionar.</small>
          </div>

          <div class="field">
            <label>Preview</label>
            <div class="preview">
              <img id="previewImg" alt="Preview" />
            </div>
            <small class="muted" id="uploadPathHint"></small>
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label>Nombre</label>
            <input id="nameInput" type="text" placeholder="Nombre del producto" />
          </div>
          <div class="field">
            <label>Precio (ARS)</label>
            <input id="priceInput" type="number" step="0.01" placeholder="0.00" />
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label>Categoria</label>
            <input id="categoryInput" type="text" placeholder="Ej: Ofertas (para carrusel)" />
          </div>
          <div class="field">
            <label>Activo</label>
            <select id="activeSelect">
              <option value="true" selected>Si</option>
              <option value="false">No</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label>Descripcion</label>
          <textarea id="descInput" rows="4" placeholder="Descripcion"></textarea>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div class="field">
            <label>Promocion</label>
            <label class="chk" style="margin:0">
              <input id="promoActive" type="checkbox" />
              Tiene promocion
            </label>
            <div class="muted" style="margin-top:6px">Una sola promocion por producto.</div>
          </div>

          <div class="field">
            <label>Precio promocion (ARS)</label>
            <input id="promoPrice" type="number" step="0.01" placeholder="15000" />
            <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
              <button id="promoQuickBtn" class="btn btn--ghost btn--mini" type="button">Agregar promocion</button>
              <button id="promoClearBtn" class="btn btn--ghost btn--mini" type="button">Quitar</button>
            </div>
          </div>
        </div>

        <div class="field" style="margin-top:10px">
          <label>Etiqueta promocion (opcional)</label>
          <input id="promoLabel" type="text" placeholder="Promocion" />
        </div>

        <button id="publishBtn" class="btn btn--primary" type="button">Publicar</button>
        <div id="adminMsg" class="msg"></div>

        <div class="helpBox">
          <h3>Guia rapida</h3>
          <ol class="helpSteps">
            <li>Selecciona una imagen: se sube automaticamente.</li>
            <li>Completa nombre, precio, categoria, descripcion y toca Publicar.</li>
            <li>En la lista podes: ver imagen, activar/desactivar, editar promocion y borrar.</li>
            <li>Usa Buscar y el filtro de ultimos dias para encontrar rapido.</li>
          </ol>
        </div>
      </section>

      <section class="panel">
        <div class="row">
          <div class="rowLeft">
            <h2>Productos</h2>
            <span class="muted" id="listHint"></span>
          </div>
          <div class="rowRight">
            <div class="field" style="margin:0; min-width:210px">
              <label style="display:none">Buscar</label>
              <input id="listSearch" type="search" placeholder="Buscar por nombre..." />
            </div>
            <div class="field" style="margin:0; min-width:210px">
              <label style="display:none">Filtro</label>
              <select id="recentSelect" title="Filtrar por ultimos cargados">
                <option value="all">Todos</option>
                <option value="7">Ultimos 7 dias</option>
                <option value="30">Ultimos 30 dias</option>
                <option value="90">Ultimos 90 dias</option>
              </select>
            </div>
            <button id="refreshBtn" class="btn btn--ghost" type="button">Actualizar</button>
          </div>
        </div>

        <div id="list" class="list"></div>

        <div style="margin-top:12px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center">
          <a class="brandCredit" href="https://ciborg347.onrender.com" target="_blank" rel="noopener">
            <img class="miniLogo" src="https://iili.io/qFHQVmN.png" alt="" />
            <span>Creado y dise単ado por <span class="cian">Ciborg</span> 347</span>
          </a>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <a class="btn btn--ghost btn--mini linkBtn" href="mailto:ciborg347@gmail.com?subject=Sugerencias%20Admin%20Di%20Pietro&body=Hola%20Mart%C3%ADn%2C%20te%20dejo%20una%20sugerencia%20sobre%20el%20panel%20admin%3A%0A%0A" target="_blank" rel="noopener">
              Sugerencias sobre el sitio
            </a>
            <a class="btn btn--ghost btn--mini linkBtn" href="mailto:ciborg347@gmail.com?subject=Reporte%20de%20inconveniente%20Admin%20Di%20Pietro&body=Hola%20Mart%C3%ADn%2C%20quiero%20reportar%20un%20inconveniente%3A%0A%0APasos%20para%20reproducir%3A%0A1)%0A2)%0A%0AResultado%20esperado%3A%0A%0AResultado%20actual%3A%0A%0A" target="_blank" rel="noopener">
              Reportar inconvenientes
            </a>
          </div>
        </div>
      </section>
    </section>
  </main>

  <!-- Modal editar promo -->
  <div id="promoModal" class="modal" aria-hidden="true">
    <button id="promoBackdrop" class="modal__backdrop" type="button" aria-label="Cerrar"></button>
    <div class="modal__panel" role="dialog" aria-modal="true">
      <div class="modal__header">
        <div class="modal__title" id="promoModalTitle">Promocion</div>
        <button id="promoClose" class="btn btn--ghost btn--mini" type="button" aria-label="Cerrar">X</button>
      </div>
      <div class="modal__body">
        <div class="field">
          <label>Activo</label>
          <label class="chk" style="margin:0">
            <input id="promoEditActive" type="checkbox" />
            Tiene promocion
          </label>
        </div>
        <div class="grid2">
          <div class="field">
            <label>Etiqueta</label>
            <input id="promoEditLabel" type="text" placeholder="Promocion" />
          </div>
          <div class="field">
            <label>Precio (ARS)</label>
            <input id="promoEditPrice" type="number" step="0.01" placeholder="15000" />
          </div>
        </div>
        <div class="modal__actions">
          <button id="promoSave" class="btn btn--primary" type="button">Guardar</button>
          <button id="promoDisable" class="btn btn--ghost" type="button">Desactivar</button>
        </div>
        <div id="promoModalMsg" class="msg"></div>
      </div>
    </div>
  </div>

  <!-- Modal ver imagen grande -->
  <div id="imgModal" class="modal" aria-hidden="true">
    <button id="imgBackdrop" class="modal__backdrop" type="button" aria-label="Cerrar"></button>
    <div class="modal__panel" role="dialog" aria-modal="true">
      <div class="modal__header">
        <div class="modal__title" id="imgModalTitle">Imagen</div>
        <button id="imgClose" class="btn btn--ghost btn--mini" type="button" aria-label="Cerrar">X</button>
      </div>
      <div class="modal__body">
        <div class="bigImg"><img id="imgModalImg" alt="" /></div>
        <div class="codeLine" id="imgModalUrl"></div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="wrap footer__inner">
      <small>Admin autoadministrable | Supabase Auth + RLS + Storage</small>
      <div class="footerLinks">
        <a class="brandCredit" href="https://ciborg347.onrender.com" target="_blank" rel="noopener">
          <img class="miniLogo" src="https://iili.io/qFHQVmN.png" alt="" />
          <span>Creado y dise単ado por <span class="cian">Ciborg</span> 347</span>
        </a>
        <a class="btn btn--ghost btn--mini linkBtn" href="mailto:ciborg347@gmail.com?subject=Sugerencias%20Admin%20Di%20Pietro&body=Hola%20Mart%C3%ADn%2C%20te%20dejo%20una%20sugerencia%20sobre%20el%20panel%20admin%3A%0A%0A" target="_blank" rel="noopener">
          Sugerencias sobre el sitio
        </a>
        <a class="btn btn--ghost btn--mini linkBtn" href="mailto:ciborg347@gmail.com?subject=Reporte%20de%20inconveniente%20Admin%20Di%20Pietro&body=Hola%20Mart%C3%ADn%2C%20quiero%20reportar%20un%20inconveniente%3A%0A%0APasos%20para%20reproducir%3A%0A1)%0A2)%0A%0AResultado%20esperado%3A%0A%0AResultado%20actual%3A%0A%0A" target="_blank" rel="noopener">
          Reportar inconvenientes
        </a>
      </div>
    </div>
  </footer>

<script>
/* ========= PWA in a single file (best effort) ========= */
(function setupPWA(){
  const APP_NAME = "Admin Di Pietro";
  const START_URL = "./";
  const ICON = "https://iili.io/qFHQVmN.png";

  const manifest = {
    name: APP_NAME,
    short_name: "Admin",
    start_url: START_URL,
    scope: "./",
    display: "standalone",
    background_color: "#0b1220",
    theme_color: "#0b1220",
    icons: [
      { src: ICON, sizes: "192x192", type: "image/png" },
      { src: ICON, sizes: "512x512", type: "image/png" }
    ]
  };

  const dataUrl = "data:application/manifest+json;charset=utf-8," + encodeURIComponent(JSON.stringify(manifest));
  const ml = document.getElementById("manifestLink");
  if(ml) ml.setAttribute("href", dataUrl);

  if("serviceWorker" in navigator){
    try{
      const swCode = `
        const CACHE = "admin-dipietro-v1";
        self.addEventListener("install", (e)=>{ self.skipWaiting(); });
        self.addEventListener("activate", (e)=>{ e.waitUntil(self.clients.claim()); });
        self.addEventListener("fetch", (e)=>{ /* sin cache agresivo */ });
      `;
      const swBlob = new Blob([swCode], { type:"text/javascript" });
      const swUrl = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swUrl, { scope:"./" }).catch(()=>{});
    }catch{}
  }
})();

/* ========= Theme ========= */
function setTheme(t){
  const theme = (t === "dark") ? "dark" : "light";
  document.documentElement.setAttribute("data-theme", theme);
  try{ localStorage.setItem("admin_theme", theme); }catch{}
  const themeTxt = document.getElementById("themeTxt");
  if(themeTxt) themeTxt.textContent = (theme === "dark") ? "Oscuro" : "Claro";
}
function initTheme(){
  let saved = "";
  try{ saved = localStorage.getItem("admin_theme") || ""; }catch{}
  if(saved !== "dark" && saved !== "light"){
    const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    saved = prefersDark ? "dark" : "light";
  }
  setTheme(saved);
}
initTheme();
document.getElementById("themeBtn").addEventListener("click", ()=>{
  const cur = document.documentElement.getAttribute("data-theme") || "light";
  setTheme(cur === "dark" ? "light" : "dark");
});

/* ========= Supabase / Admin ========= */
const SUPABASE_URL = "https://etqcufdmduqbmilpyyfg.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0cWN1ZmRtZHVxYm1pbHB5eWZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NTQ1NzIsImV4cCI6MjA4NzEzMDU3Mn0.fHrf3E9HmEjOyzh8n7eusvy_SOkQf4zshDpxRzKGx10";

const BUCKET_NAME = "product-images";
const UPLOAD_PREFIX = "products/";

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

const splash = document.getElementById("splash");

const authBox = document.getElementById("authBox");
const adminBox = document.getElementById("adminBox");

const emailInput = document.getElementById("emailInput");
const passInput = document.getElementById("passInput");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const authMsg = document.getElementById("authMsg");
const userEmail = document.getElementById("userEmail");

const imageInput = document.getElementById("imageInput");
const previewImg = document.getElementById("previewImg");
const uploadPathHint = document.getElementById("uploadPathHint");

const nameInput = document.getElementById("nameInput");
const priceInput = document.getElementById("priceInput");
const categoryInput = document.getElementById("categoryInput");
const activeSelect = document.getElementById("activeSelect");
const descInput = document.getElementById("descInput");

const promoActive = document.getElementById("promoActive");
const promoPrice = document.getElementById("promoPrice");
const promoLabel = document.getElementById("promoLabel");
const promoQuickBtn = document.getElementById("promoQuickBtn");
const promoClearBtn = document.getElementById("promoClearBtn");

const publishBtn = document.getElementById("publishBtn");
const adminMsg = document.getElementById("adminMsg");

const listEl = document.getElementById("list");
const refreshBtn = document.getElementById("refreshBtn");
const listSearch = document.getElementById("listSearch");
const recentSelect = document.getElementById("recentSelect");
const listHint = document.getElementById("listHint");

const promoModal = document.getElementById("promoModal");
const promoBackdrop = document.getElementById("promoBackdrop");
const promoClose = document.getElementById("promoClose");
const promoModalTitle = document.getElementById("promoModalTitle");
const promoEditActive = document.getElementById("promoEditActive");
const promoEditLabel = document.getElementById("promoEditLabel");
const promoEditPrice = document.getElementById("promoEditPrice");
const promoSave = document.getElementById("promoSave");
const promoDisable = document.getElementById("promoDisable");
const promoModalMsg = document.getElementById("promoModalMsg");

const imgModal = document.getElementById("imgModal");
const imgBackdrop = document.getElementById("imgBackdrop");
const imgClose = document.getElementById("imgClose");
const imgModalTitle = document.getElementById("imgModalTitle");
const imgModalImg = document.getElementById("imgModalImg");
const imgModalUrl = document.getElementById("imgModalUrl");

let uploadedImageUrl = "";
let uploadedImagePath = "";
let promoEditingId = null;
let productsCache = [];

function setAuthMsg(msg){ authMsg.textContent = msg || ""; }
function setAdminMsg(msg){ adminMsg.textContent = msg || ""; }
function setPromoModalMsg(msg){ promoModalMsg.textContent = msg || ""; }

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function money(n){
  try{ return new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS"}).format(Number(n||0)); }
  catch{ return "$" + Number(n||0).toFixed(2); }
}
function norm(s){ return String(s||"").trim().toLowerCase(); }

promoQuickBtn.addEventListener("click", ()=>{
  promoActive.checked = true;
  if(!(promoLabel.value||"").trim()) promoLabel.value = "Promocion";
  promoPrice.focus();
});
promoClearBtn.addEventListener("click", ()=>{
  promoActive.checked = false;
  promoLabel.value = "";
  promoPrice.value = "";
});

async function whitelistCheck(){
  const { data } = await sb.auth.getUser();
  const email = data?.user?.email || "";
  if(!email) return { ok:false, reason:"No hay sesion activa." };

  const { data: row, error } = await sb
    .from("admin_users")
    .select("email")
    .eq("email", email)
    .maybeSingle();

  if(error){
    console.error(error);
    return { ok:false, reason:"No se pudo verificar whitelist. Revisa policy de admin_users." };
  }
  if(!row?.email){
    return { ok:false, reason:"No estas en whitelist (tabla admin_users)." };
  }
  return { ok:true, email };
}

async function guardAdmin(){
  const { data } = await sb.auth.getSession();
  const session = data?.session;

  if(!session){
    authBox.style.display = "block";
    adminBox.style.display = "none";
    userEmail.textContent = "";
    hideSplash();
    return;
  }

  const check = await whitelistCheck();
  if(!check.ok){
    setAuthMsg(check.reason);
    await sb.auth.signOut();
    authBox.style.display = "block";
    adminBox.style.display = "none";
    userEmail.textContent = "";
    hideSplash();
    return;
  }

  userEmail.textContent = check.email;
  setAuthMsg("");
  authBox.style.display = "none";
  adminBox.style.display = "block";
  await loadProductsList();
  hideSplash();
}

loginBtn.addEventListener("click", async ()=>{
  setAuthMsg("Ingresando...");
  const email = (emailInput.value||"").trim();
  const password = passInput.value || "";

  if(!email || !password){
    setAuthMsg("Completa email y password.");
    return;
  }

  const { error } = await sb.auth.signInWithPassword({ email, password });
  if(error){
    console.error(error);
    setAuthMsg(`No autenticado: ${error.message}`);
    return;
  }

  await guardAdmin();
});

logoutBtn.addEventListener("click", async ()=>{
  await sb.auth.signOut();
  resetFormState();
  setAdminMsg("");
  setAuthMsg("");
  await guardAdmin();
});

refreshBtn.addEventListener("click", loadProductsList);

function resetFormState(){
  uploadedImageUrl = "";
  uploadedImagePath = "";
  uploadPathHint.textContent = "";
  previewImg.removeAttribute("src");
  imageInput.value = "";
  promoActive.checked = false;
  promoPrice.value = "";
  promoLabel.value = "";
}

async function uploadSelectedImage(file){
  setAdminMsg("Subiendo imagen...");
  const ext = (file.name.split(".").pop() || "jpg").toLowerCase().replace(/[^a-z0-9]/g,"") || "jpg";
  const path = `${UPLOAD_PREFIX}${Date.now()}_${Math.random().toString(16).slice(2)}.${ext}`;

  const { error: upErr } = await sb
    .storage
    .from(BUCKET_NAME)
    .upload(path, file, { upsert:false, contentType:file.type });

  if(upErr){
    console.error(upErr);
    setAdminMsg(`Error al subir imagen: ${upErr.message}`);
    return false;
  }

  const { data: pub } = sb.storage.from(BUCKET_NAME).getPublicUrl(path);
  uploadedImageUrl = pub?.publicUrl || "";
  uploadedImagePath = path;

  if(!uploadedImageUrl){
    setAdminMsg("Imagen subida pero no se genero URL publica. Revisa bucket PUBLIC.");
    return false;
  }

  uploadPathHint.textContent = `Ruta: ${uploadedImagePath}`;
  setAdminMsg("Imagen subida OK. Ahora completa los datos y publica.");
  return true;
}

imageInput.addEventListener("change", async ()=>{
  setAdminMsg("");
  const file = imageInput.files?.[0];
  if(!file) return;

  if(!file.type.startsWith("image/")){
    setAdminMsg("El archivo debe ser una imagen.");
    imageInput.value = "";
    return;
  }

  previewImg.src = URL.createObjectURL(file);

  const check = await whitelistCheck();
  if(!check.ok){
    setAdminMsg("No estas autorizado para subir imagenes. Revisa whitelist/admin login.");
    return;
  }

  await uploadSelectedImage(file);
});

publishBtn.addEventListener("click", async ()=>{
  setAdminMsg("");

  const name = (nameInput.value||"").trim();
  const description = (descInput.value||"").trim();
  const category = (categoryInput.value||"").trim();
  const active = activeSelect.value === "true";
  const priceRaw = (priceInput.value||"").trim();
  const price = Number(priceRaw);

  const promoOn = !!promoActive.checked;
  const promoLabelVal = (promoLabel.value||"").trim() || "Promocion";
  const promoPriceRaw = (promoPrice.value||"").trim();
  const promoPriceVal = promoOn ? Number(promoPriceRaw) : null;

  if(!uploadedImageUrl){
    setAdminMsg("Primero subi la imagen (upload inmediato).");
    return;
  }
  if(!name){
    setAdminMsg("Falta el nombre.");
    return;
  }
  if(!priceRaw || Number.isNaN(price) || price <= 0){
    setAdminMsg("Precio invalido (ej 339.90).");
    return;
  }
  if(promoOn){
    if(!promoPriceRaw || Number.isNaN(promoPriceVal) || promoPriceVal <= 0){
      setAdminMsg("Promocion activa: el precio de promocion debe ser mayor a 0.");
      return;
    }
  }

  setAdminMsg("Publicando producto...");

  const payload = {
    name,
    description,
    price,
    category,
    image_url: uploadedImageUrl,
    active,
    promo_active: promoOn,
    promo_label: promoOn ? promoLabelVal : null,
    promo_price: promoOn ? promoPriceVal : null,
    image_path: uploadedImagePath || null
  };

  const { error } = await sb.from("products").insert([payload]);

  if(error){
    console.error(error);
    setAdminMsg(`No se pudo publicar: ${error.message}`);
    return;
  }

  nameInput.value = "";
  priceInput.value = "";
  categoryInput.value = "";
  descInput.value = "";
  activeSelect.value = "true";
  resetFormState();

  setAdminMsg("Publicado OK.");
  await loadProductsList();
});

/* Modal promo */
function openPromoModal(p){
  promoEditingId = p.id;
  promoModalTitle.textContent = `Promocion: ${p.name}`;
  promoEditActive.checked = !!p.promo_active;
  promoEditLabel.value = (p.promo_label || "Promocion");
  promoEditPrice.value = (p.promo_price != null) ? String(p.promo_price) : "";
  setPromoModalMsg("");
  promoModal.classList.add("isOpen");
  promoModal.setAttribute("aria-hidden","false");
}
function closePromoModal(){
  promoModal.classList.remove("isOpen");
  promoModal.setAttribute("aria-hidden","true");
  promoEditingId = null;
}
promoBackdrop.addEventListener("click", closePromoModal);
promoClose.addEventListener("click", closePromoModal);

promoSave.addEventListener("click", async ()=>{
  setPromoModalMsg("");
  if(!promoEditingId) return;

  const on = !!promoEditActive.checked;
  const label = (promoEditLabel.value||"").trim() || "Promocion";
  const priceRaw = (promoEditPrice.value||"").trim();
  const price = on ? Number(priceRaw) : null;

  if(on){
    if(!priceRaw || Number.isNaN(price) || price <= 0){
      setPromoModalMsg("Promocion activa: el precio debe ser mayor a 0.");
      return;
    }
  }

  promoSave.disabled = true;
  promoDisable.disabled = true;

  const payload = {
    promo_active: on,
    promo_label: on ? label : null,
    promo_price: on ? price : null
  };

  const { error } = await sb.from("products").update(payload).eq("id", promoEditingId);

  if(error){
    console.error(error);
    setPromoModalMsg(`No se pudo guardar: ${error.message}`);
  }else{
    setPromoModalMsg("Guardado OK.");
    await loadProductsList();
  }

  promoSave.disabled = false;
  promoDisable.disabled = false;
});

promoDisable.addEventListener("click", async ()=>{
  setPromoModalMsg("");
  if(!promoEditingId) return;

  promoSave.disabled = true;
  promoDisable.disabled = true;

  const { error } = await sb.from("products").update({ promo_active:false, promo_label:null, promo_price:null }).eq("id", promoEditingId);

  if(error){
    console.error(error);
    setPromoModalMsg(`No se pudo desactivar: ${error.message}`);
  }else{
    setPromoModalMsg("Desactivado OK.");
    await loadProductsList();
  }

  promoSave.disabled = false;
  promoDisable.disabled = false;
});

/* Modal imagen grande */
function openImgModal(p){
  imgModalTitle.textContent = p.name || "Imagen";
  imgModalImg.src = p.image_url || "";
  imgModalImg.alt = p.name || "";
  imgModalUrl.textContent = p.image_url || "";
  imgModal.classList.add("isOpen");
  imgModal.setAttribute("aria-hidden","false");
}
function closeImgModal(){
  imgModal.classList.remove("isOpen");
  imgModal.setAttribute("aria-hidden","true");
  imgModalImg.removeAttribute("src");
  imgModalUrl.textContent = "";
}
imgBackdrop.addEventListener("click", closeImgModal);
imgClose.addEventListener("click", closeImgModal);

function applyListFilters(){
  const q = norm(listSearch.value);
  const days = recentSelect.value;
  const now = Date.now();

  let out = productsCache.slice();

  if(days !== "all"){
    const ms = Number(days) * 24 * 60 * 60 * 1000;
    out = out.filter(p=>{
      const t = new Date(p.created_at).getTime();
      return Number.isFinite(t) && (now - t) <= ms;
    });
  }

  if(q){
    out = out.filter(p => norm(p.name).includes(q));
  }

  renderProductsList(out);
}

listSearch.addEventListener("input", applyListFilters);
recentSelect.addEventListener("change", applyListFilters);

function renderProductsList(items){
  const total = productsCache.length;
  listHint.textContent = items.length ? `Mostrando ${items.length} de ${total}` : `0 de ${total}`;

  if(!items.length){
    listEl.innerHTML = `<div class="msg">No hay productos para mostrar con este filtro.</div>`;
    return;
  }

  listEl.innerHTML = items.map((p)=>{
    const promoOn = (p.promo_active && Number(p.promo_price||0)>0);
    const promoPill = promoOn ? `<span class="pill pill--promo">PROMO +${escapeHtml(money(p.promo_price))}</span>` : "";
    return `
      <div class="item">
        <div style="display:grid; grid-template-columns: auto 1fr; gap:10px; align-items:start">
          <button class="thumb" data-img="${escapeHtml(p.id)}" type="button" title="Ver imagen grande">
            <img src="${escapeHtml(p.image_url||"")}" alt="${escapeHtml(p.name||"")}" loading="lazy" />
          </button>
          <div>
            <div class="item__title">${escapeHtml(p.name)}</div>
            <div class="item__meta">${escapeHtml(p.category||"")} | ${money(p.price)}</div>
            <div class="item__meta">${new Date(p.created_at).toLocaleString("es-AR")} | ${p.active ? "Activo" : "Inactivo"}</div>
          </div>
        </div>
        <div class="item__actions">
          ${promoPill}
          <span class="pill">${p.active ? "ON" : "OFF"}</span>
          <button class="btn btn--ghost btn--mini" data-promo="${escapeHtml(p.id)}" type="button">Promocion</button>
          <button class="btn btn--ghost btn--mini" data-toggle="${escapeHtml(p.id)}" type="button">${p.active ? "Desactivar" : "Activar"}</button>
          <button class="btn btn--danger btn--mini" data-del="${escapeHtml(p.id)}" type="button">Borrar</button>
        </div>
      </div>
    `;
  }).join("");

  listEl.querySelectorAll("[data-img]").forEach((btn)=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-img");
      const p = productsCache.find(x=>String(x.id)===String(id));
      if(p) openImgModal(p);
    });
  });

  listEl.querySelectorAll("[data-promo]").forEach((btn)=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-promo");
      const p = productsCache.find(x=>String(x.id)===String(id));
      if(p) openPromoModal(p);
    });
  });

  listEl.querySelectorAll("[data-toggle]").forEach((btn)=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-toggle");
      const current = productsCache.find(x=>String(x.id)===String(id));
      if(!current) return;

      btn.disabled = true;

      const { error: upErr } = await sb.from("products").update({ active: !current.active }).eq("id", id);

      if(upErr){
        console.error(upErr);
        setAdminMsg(`No se pudo actualizar: ${upErr.message}`);
      }else{
        await loadProductsList();
      }
      btn.disabled = false;
    });
  });

  listEl.querySelectorAll("[data-del]").forEach((btn)=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-del");
      const ok = confirm("Borrar este producto? No se puede deshacer.");
      if(!ok) return;

      btn.disabled = true;

      const { error: delErr } = await sb.from("products").delete().eq("id", id);

      if(delErr){
        console.error(delErr);
        setAdminMsg(`No se pudo borrar: ${delErr.message}`);
      }else{
        await loadProductsList();
      }
      btn.disabled = false;
    });
  });
}

async function loadProductsList(){
  setAdminMsg("");
  listHint.textContent = "Cargando...";

  const { data, error } = await sb
    .from("products")
    .select("id,name,price,category,active,created_at,image_url,promo_active,promo_label,promo_price")
    .order("created_at", { ascending:false })
    .limit(500);

  if(error){
    console.error(error);
    listEl.innerHTML = `<div class="msg">No se pudieron cargar productos: ${escapeHtml(error.message)}</div>`;
    listHint.textContent = "";
    return;
  }

  productsCache = data || [];
  applyListFilters();
}

/* Splash handling */
function hideSplash(){
  if(!splash) return;
  splash.setAttribute("aria-hidden","true");
  splash.style.display = "none";
}

/* Boot */
sb.auth.onAuthStateChange(()=>{ guardAdmin(); });

window.addEventListener("load", ()=>{
  setTimeout(()=>{ guardAdmin(); }, 150);
  setTimeout(()=>{ hideSplash(); }, 2500);
});
</script>
</body>
</html>
